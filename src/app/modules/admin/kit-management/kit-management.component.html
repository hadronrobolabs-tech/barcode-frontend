<div class="management-container">
  <!-- Kit Form -->
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ editingKit ? 'edit' : 'add' }}</mat-icon>
        {{ editingKit ? 'Edit Kit' : 'Add New Kit' }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="kitForm" (ngSubmit)="onSubmit()" class="kit-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Kit Name</mat-label>
            <input matInput formControlName="kit_name" placeholder="e.g., Motor Assembly Kit" />
            <mat-icon matPrefix>inventory_2</mat-icon>
            <mat-error *ngIf="kitForm.get('kit_name')?.hasError('required') && kitForm.get('kit_name')?.touched">
              Kit name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description (Optional)</mat-label>
            <textarea matInput formControlName="description" rows="2" placeholder="Kit description"></textarea>
            <mat-icon matPrefix>description</mat-icon>
          </mat-form-field>
        </div>

        <div class="button-group">
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || kitForm.invalid">
            <mat-icon>{{ editingKit ? 'save' : 'add' }}</mat-icon>
            <span>{{ loading ? 'Saving...' : (editingKit ? 'Update Kit' : 'Create Kit') }}</span>
          </button>
          <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="loading">
            <mat-icon>cancel</mat-icon>
            <span>Cancel</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Kits List -->
  <mat-card class="list-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Kits ({{ kits.length }})
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loading && kits.length === 0" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
      </div>

      <table mat-table [dataSource]="dataSource" class="kits-table" *ngIf="kits.length > 0">
        <ng-container matColumnDef="kit_name">
          <th mat-header-cell *matHeaderCellDef>Kit Name</th>
          <td mat-cell *matCellDef="let kit">{{ kit.kit_name }}</td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let kit">{{ kit.description || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="components_count">
          <th mat-header-cell *matHeaderCellDef>Components</th>
          <td mat-cell *matCellDef="let kit">
            {{ kit.components?.length || 0 }} category(ies)
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let kit">
            <button mat-icon-button color="primary" (click)="selectKitForComponents(kit)" title="Manage Components">
              <mat-icon>settings</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="editKit(kit)" title="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteKit(kit)" title="Delete">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div *ngIf="!loading && kits.length === 0" class="empty-state">
        <mat-icon>inventory_2</mat-icon>
        <p>No kits found. Create your first kit above.</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Kit Components Management -->
  <mat-card *ngIf="selectedKit" class="components-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>settings</mat-icon>
        Manage Components for: {{ selectedKit.kit_name }}
      </mat-card-title>
      <button mat-icon-button (click)="selectedKit = null; kitComponents = []" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content>
      <!-- Add Component Form -->
      <div class="add-component-section">
        <div class="section-header">
          <h3>Add Component to Kit</h3>
          <button mat-stroked-button (click)="toggleNewComponentForm()" [color]="showNewComponentForm ? 'warn' : 'primary'">
            <mat-icon>{{ showNewComponentForm ? 'close' : 'add' }}</mat-icon>
            <span>{{ showNewComponentForm ? 'Cancel' : 'Create New Component' }}</span>
          </button>
        </div>

        <form *ngIf="showNewComponentForm || showEditComponentForm" [formGroup]="componentForm" (ngSubmit)="showEditComponentForm ? updateComponent() : addComponentToKit()" class="component-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Component Name</mat-label>
              <input matInput formControlName="name" placeholder="e.g., M5 Screw, DC Motor 12V" />
              <mat-icon matPrefix>build</mat-icon>
              <mat-error *ngIf="componentForm.get('name')?.hasError('required') && componentForm.get('name')?.touched">
                Component name is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Category</mat-label>
              <mat-select formControlName="category">
                <mat-option [value]="null" disabled>Select Category</mat-option>
                <mat-option *ngFor="let cat of categories" [value]="cat.name">
                  {{ cat.name }} ({{ cat.prefix }})
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>category</mat-icon>
              <mat-error *ngIf="componentForm.get('category')?.hasError('required') && componentForm.get('category')?.touched">
                Category is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-checkbox formControlName="is_packet" class="packet-checkbox">
              Is Packet Component
            </mat-checkbox>

            <mat-form-field appearance="outline" class="full-width" *ngIf="componentForm.get('is_packet')?.value">
              <mat-label>Packet Quantity</mat-label>
              <input matInput type="number" formControlName="packet_quantity" min="1" placeholder="e.g., 50" />
              <mat-icon matPrefix>numbers</mat-icon>
              <mat-error *ngIf="componentForm.get('packet_quantity')?.hasError('required') && componentForm.get('packet_quantity')?.touched">
                Packet quantity is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description (Optional)</mat-label>
              <textarea matInput formControlName="description" rows="2" placeholder="Component description"></textarea>
              <mat-icon matPrefix>description</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Barcode Prefix</mat-label>
              <input matInput formControlName="barcode_prefix" placeholder="e.g., MOT, SCR, WIR" maxlength="10" />
              <mat-icon matPrefix>qr_code</mat-icon>
              <mat-hint>Prefix for barcode generation (2-10 characters, uppercase)</mat-hint>
              <mat-error *ngIf="componentForm.get('barcode_prefix')?.hasError('required') && componentForm.get('barcode_prefix')?.touched">
                Barcode prefix is required
              </mat-error>
              <mat-error *ngIf="componentForm.get('barcode_prefix')?.hasError('minlength') && componentForm.get('barcode_prefix')?.touched">
                Prefix must be at least 2 characters
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Required Quantity for Kit</mat-label>
              <input matInput type="number" formControlName="required_quantity" min="1" />
              <mat-icon matPrefix>inventory</mat-icon>
              <mat-hint>How many of this component are needed in the kit</mat-hint>
              <mat-error *ngIf="componentForm.get('required_quantity')?.hasError('required') && componentForm.get('required_quantity')?.touched">
                Quantity is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="button-group">
            <button mat-raised-button [color]="showEditComponentForm ? 'primary' : 'accent'" type="submit" [disabled]="loading || componentForm.invalid">
              <mat-icon>{{ showEditComponentForm ? 'save' : 'add' }}</mat-icon>
              <span>{{ loading ? (showEditComponentForm ? 'Updating...' : 'Adding...') : (showEditComponentForm ? 'Update Component' : 'Create & Add Component') }}</span>
            </button>
            <button mat-stroked-button type="button" (click)="resetComponentForm()" [disabled]="loading">
              <mat-icon>cancel</mat-icon>
              <span>Cancel</span>
            </button>
          </div>
        </form>

        <div *ngIf="!showNewComponentForm && !showEditComponentForm" class="info-message">
          <mat-icon>info</mat-icon>
          <p>Click "Create New Component" to add a component to this kit. Components are created and added to the kit in one step.</p>
        </div>
      </div>

      <!-- Kit Components List -->
      <div class="kit-components-list" *ngIf="kitComponents.length > 0">
        <h3>Kit Components ({{ kitComponents.length }})</h3>
        <table mat-table [dataSource]="kitComponents" class="kit-components-table">
          <ng-container matColumnDef="component">
            <th mat-header-cell *matHeaderCellDef>Component</th>
            <td mat-cell *matCellDef="let comp">
              <div class="component-info">
                <div class="component-name">{{ comp.component_name || comp.category_name }}</div>
                <div class="component-category" *ngIf="comp.component_name">
                  <mat-chip>{{ comp.category_name }}</mat-chip>
                </div>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Required Quantity</th>
            <td mat-cell *matCellDef="let comp">
              <mat-form-field appearance="outline" class="quantity-field">
                <input 
                  matInput
                  type="number" 
                  [(ngModel)]="comp.required_quantity" 
                  min="1"
                  (blur)="updateKitComponent(comp)"
                  [disabled]="loading" />
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="barcode_prefix">
            <th mat-header-cell *matHeaderCellDef>Barcode Prefix</th>
            <td mat-cell *matCellDef="let comp">{{ comp.barcode_prefix || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let comp">
              <button 
                *ngIf="comp.component_id"
                mat-icon-button 
                color="primary" 
                (click)="editComponent(comp)" 
                title="Edit Component"
                [disabled]="loading">
                <mat-icon>edit</mat-icon>
              </button>
              <button 
                *ngIf="comp.component_id"
                mat-icon-button 
                color="warn" 
                (click)="deleteComponent(comp)" 
                title="Delete Component"
                [disabled]="loading">
                <mat-icon>delete</mat-icon>
              </button>
              <button 
                *ngIf="!comp.component_id"
                mat-icon-button 
                color="warn" 
                (click)="removeKitComponent(comp)" 
                title="Remove from Kit"
                [disabled]="loading">
                <mat-icon>remove_circle</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['component', 'quantity', 'barcode_prefix', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['component', 'quantity', 'barcode_prefix', 'actions'];"></tr>
        </table>
      </div>

      <div *ngIf="kitComponents.length === 0" class="empty-state">
        <mat-icon>category</mat-icon>
        <p>No components added to this kit. Add components above.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
