<div class="page-container">
  <div class="page-header">
    <h1>Generate Barcodes</h1>
    <p class="subtitle">Create barcode labels for kit components and boxes</p>
  </div>

  <mat-card class="form-card">
    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Select Kit/Product</mat-label>
          <mat-select 
            [(ngModel)]="selectedKitId"
            (selectionChange)="onKitSelect()"
            [disabled]="loading">
            <mat-option [value]="null" disabled>Select Kit</mat-option>
            <mat-option *ngFor="let kit of kits" [value]="kit.id">
              {{ kit.kit_name || kit.name }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>inventory_2</mat-icon>
        </mat-form-field>
      </div>

      <!-- Component Selection (shown only when kit is selected and box barcode is NOT selected) -->
      <div *ngIf="selectedKitId && !generateBoxBarcode" class="components-section">
        <div *ngIf="loading && componentOptions.length === 0" class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading components...</p>
        </div>

        <div *ngIf="!loading && componentOptions.length > 0">
          <div class="section-header">
            <h3>Generate Component Barcodes for {{ selectedKitName }}</h3>
          </div>

          <div class="component-selection-row">
            <mat-form-field appearance="outline" class="component-dropdown">
              <mat-label>Select Component</mat-label>
              <mat-select 
                [(ngModel)]="selectedComponentId"
                (selectionChange)="onComponentSelect()"
                [disabled]="loading">
                <mat-option [value]="null">Select Component</mat-option>
                <mat-option *ngFor="let comp of componentOptions" [value]="comp.id">
                  {{ comp.display_label || comp.name }} ({{ comp.category_name }})
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>inventory</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="quantity-input" *ngIf="selectedComponentId">
              <mat-label>Quantity</mat-label>
              <input 
                matInput
                type="number" 
                [(ngModel)]="componentQuantity"
                min="1" 
                [disabled]="loading" />
              <mat-icon matPrefix>numbers</mat-icon>
              <mat-hint>Number of barcodes to generate</mat-hint>
            </mat-form-field>
          </div>

          <div class="quantity-info" *ngIf="selectedComponentId">
            <mat-icon>info</mat-icon>
            <span>{{ componentQuantity }} barcode(s) will be generated for selected component</span>
          </div>
        </div>

        <div *ngIf="!loading && componentOptions.length === 0 && selectedKitId" class="empty-components">
          <mat-icon>info</mat-icon>
          <p>No components found for this kit. Please add components to the kit in Admin Panel first.</p>
        </div>
      </div>

      <!-- Box Barcode Generation Option -->
      <div *ngIf="selectedKitId" class="box-barcode-section">
        <div class="section-header">
          <h3>Generate Box Barcodes for {{ selectedKitName }}</h3>
        </div>
        <mat-card class="box-option-card">
          <mat-card-content>
            <div class="box-option-row">
              <mat-checkbox 
                [(ngModel)]="generateBoxBarcode"
                (change)="onBoxBarcodeToggle()"
                [disabled]="selectedComponentId !== null">
                Generate Box Barcode
              </mat-checkbox>
              <mat-form-field appearance="outline" class="box-quantity-field" *ngIf="generateBoxBarcode">
                <mat-label>Box Quantity</mat-label>
                <input 
                  matInput
                  type="number" 
                  [(ngModel)]="boxBarcodeQuantity"
                  min="1" 
                  [disabled]="loading" />
                <mat-icon matPrefix>numbers</mat-icon>
                <mat-hint>Number of box barcodes to generate</mat-hint>
              </mat-form-field>
            </div>
            <div class="quantity-info" *ngIf="generateBoxBarcode">
              <mat-icon>info</mat-icon>
              <span>{{ boxBarcodeQuantity }} box barcode(s) will be generated</span>
            </div>
            <div class="validation-hint" *ngIf="selectedComponentId !== null">
              <mat-icon>warning</mat-icon>
              <span>Component selected. Unselect component to generate box barcodes.</span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="errorMessage" class="error-message">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
      </div>
      <div *ngIf="successMessage" class="success-message">
        <mat-icon>check_circle</mat-icon>
        <span>{{ successMessage }}</span>
      </div>

      <div class="button-group">
        <button 
          mat-raised-button 
          color="primary"
          (click)="generateBarcodes()"
          [disabled]="loading || !selectedKitId || (getSelectedCount() === 0 && !generateBoxBarcode)"
          class="generate-btn">
          <mat-icon>qr_code_scanner</mat-icon>
          <span>{{ loading ? 'Generating...' : 'Generate Barcodes' }}</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="generatedBarcodes.length > 0" class="results-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>check_circle</mat-icon>
        Generated Barcodes ({{ generatedBarcodes.length }})
      </mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="generateBoxBarcode">{{ boxBarcodeQuantity }} box barcode(s) generated</span>
        <span *ngIf="!generateBoxBarcode && selectedComponentId">{{ componentQuantity }} component barcode(s) generated</span>
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="barcodes-grid">
        <mat-chip *ngFor="let barcode of generatedBarcodes" class="barcode-chip">
          {{ barcode.barcode_value || barcode }}
        </mat-chip>
      </div>
      <div class="action-buttons">
          <button 
            mat-raised-button 
            color="primary"
            (click)="printTSPL()" 
            [disabled]="loading"
            class="print-btn"
            title="Download TSPL file to print on your laptop printer">
            <mat-icon>print</mat-icon>
            <span>{{ loading ? 'Generating...' : 'Print Labels (Download TSPL)' }}</span>
          </button>
          <button 
            mat-raised-button 
            color="warn"
            (click)="directPrint()" 
            [disabled]="loading"
            class="direct-print-btn"
            title="Direct Print via QZ Tray - Requires QZ Tray installed and running">
            <mat-icon>print_disabled</mat-icon>
            <span>{{ loading ? 'Printing...' : 'Direct Print' }}</span>
          </button>
        <button 
          mat-raised-button 
          color="accent"
          (click)="downloadPdf()" 
          [disabled]="loading"
          class="download-btn">
          <mat-icon>download</mat-icon>
          <span>{{ loading ? 'Downloading...' : 'Download PDF' }}</span>
        </button>
        <button 
          mat-stroked-button 
          (click)="reset()"
          class="reset-btn">
          <mat-icon>refresh</mat-icon>
          <span>Reset</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Barcode Lookup for Box Code PDF -->
  <mat-card class="lookup-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>qr_code</mat-icon>
        Barcode Lookup - Box Code PDF
      </mat-card-title>
      <mat-card-subtitle>Enter barcode list to download box code PDF</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="lookup-section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Enter Barcode List (comma or newline separated)</mat-label>
          <textarea
            matInput
            [(ngModel)]="barcodeListInput"
            placeholder="Enter barcodes separated by comma or newline&#10;Example: BARCODE1, BARCODE2, BARCODE3"
            rows="5"
            [disabled]="loading"
            class="barcode-textarea"></textarea>
          <mat-icon matPrefix>list</mat-icon>
          <mat-hint>Enter barcodes separated by comma or newline. Each barcode will be looked up and box code PDF will be generated.</mat-hint>
        </mat-form-field>

        <div class="button-group">
          <button 
            mat-raised-button 
            color="primary"
            (click)="downloadBoxCodePdf()"
            [disabled]="loading || !barcodeListInput.trim()"
            class="download-box-code-btn">
            <mat-icon>download</mat-icon>
            <span>{{ loading ? 'Generating PDF...' : 'Download Box Code PDF' }}</span>
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
