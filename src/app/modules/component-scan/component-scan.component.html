<div class="page-container">
  <div class="page-header">
    <h1>Component Scan</h1>
    <p class="subtitle">Scan and validate component barcodes</p>
  </div>

  <mat-card class="scan-card">
    <mat-card-content>
      <div class="scan-input-section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Enter or Scan Barcode</mat-label>
          <input
            #barcodeInputField
            matInput
            type="text"
            placeholder="Scan barcode here"
            [(ngModel)]="barcodeInput"
            (keyup.enter)="scan()"
            (input)="clearMessages()"
            [disabled]="loading"
            autofocus
          />
          <mat-icon matPrefix>qr_code_scanner</mat-icon>
        </mat-form-field>

        <button 
          mat-raised-button 
          color="primary" 
          (click)="scan()" 
          [disabled]="loading || !barcodeInput.trim()"
          class="scan-button">
          <mat-icon *ngIf="!loading">scanner</mat-icon>
          <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
          <span>{{ loading ? 'Scanning...' : 'Scan' }}</span>
        </button>
      </div>

      <div *ngIf="errorMessage" class="error-message">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
      </div>

      <div *ngIf="successMessage" class="success-message">
        <mat-icon>check_circle</mat-icon>
        <span>{{ successMessage }}</span>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="scannedItem" class="preview-card">
    <mat-card-header>
      <mat-card-title>Barcode Details</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="details-grid">
        <div class="detail-item">
          <span class="label">Component:</span>
          <span class="value">{{ scannedItem.componentName }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Category:</span>
          <span class="value">{{ scannedItem.category }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Barcode:</span>
          <span class="value barcode-value">{{ scannedItem.barcode }}</span>
        </div>
        <div class="detail-item" *ngIf="scannedItem.product">
          <span class="label">Product:</span>
          <span class="value">{{ scannedItem.product }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Current Status:</span>
          <mat-chip [class]="'status-chip ' + scannedItem.current_status?.toLowerCase()">
            {{ scannedItem.current_status }}
          </mat-chip>
        </div>
      </div>
      <div class="pending-note">
        <mat-icon>schedule</mat-icon>
        <span>Pending - Will be saved when you click "Submit Scans"</span>
      </div>
      
      <!-- Show child sub-components if this is a parent component -->
      <div *ngIf="scannedItem.isParent && scannedItem.childComponents && scannedItem.childComponents.length > 0" class="child-components-section">
        <div class="child-components-header">
          <mat-icon>account_tree</mat-icon>
          <span class="header-text">Child Sub-Components Required:</span>
        </div>
        <div class="child-components-list">
          <div *ngFor="let child of scannedItem.childComponents" class="child-component-item">
            <div class="child-info-row">
              <div class="child-info">
                <strong>{{ child.component_name }}</strong>
                <span class="child-category">({{ child.category }})</span>
              </div>
              <div class="child-status">
                <span class="child-quantity">Required: {{ child.required_quantity }}</span>
                <span class="child-scanned">
                  Scanned: {{ getScannedCountForChild(scannedItem, child) }} / {{ child.required_quantity }}
                </span>
                <mat-icon *ngIf="getScannedCountForChild(scannedItem, child) >= child.required_quantity" 
                          class="check-icon" 
                          color="primary">check_circle</mat-icon>
              </div>
            </div>
          </div>
        </div>
        <div class="child-progress-summary" *ngIf="scannedItem.childComponents && scannedItem.childComponents.length > 0">
          <mat-icon>info</mat-icon>
          <span>
            Total Progress: {{ getTotalScannedCount(scannedItem) }} / {{ getTotalRequiredCount(scannedItem) }} child barcodes scanned
          </span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="scanHistory.length > 0" class="history-card">
    <mat-card-header>
      <div class="card-header-content">
        <div>
          <mat-card-title>Scanned Items</mat-card-title>
          <mat-card-subtitle>
            {{ pendingCount }} pending, 
            {{ savedCount }} saved
          </mat-card-subtitle>
        </div>
        <div class="action-buttons">
          <button 
            *ngIf="hasPendingScans"
            mat-raised-button 
            color="primary"
            (click)="submitScans()" 
            [disabled]="loading"
            class="submit-btn">
            <mat-icon>save</mat-icon>
            <span>{{ loading ? 'Submitting...' : 'Submit Scans (' + pendingCount + ')' }}</span>
          </button>
          <button 
            mat-raised-button 
            color="accent"
            (click)="exportScannedBarcodes()" 
            [disabled]="loading"
            class="export-btn"
            matTooltip="Export all scanned barcodes (not boxed) to Excel/CSV">
            <mat-icon>download</mat-icon>
            <span>{{ loading ? 'Exporting...' : 'Export Scanned Barcodes' }}</span>
          </button>
        </div>
      </div>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="scans-table">
          <ng-container matColumnDef="barcode">
            <th mat-header-cell *matHeaderCellDef>Barcode</th>
            <td mat-cell *matCellDef="let item">{{ item.barcode }}</td>
          </ng-container>

          <ng-container matColumnDef="component">
            <th mat-header-cell *matHeaderCellDef>Component</th>
            <td mat-cell *matCellDef="let item">{{ item.componentName }}</td>
          </ng-container>

          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Category</th>
            <td mat-cell *matCellDef="let item">{{ item.category }}</td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let item">
              <mat-chip [class]="item.pending ? 'pending-chip' : 'saved-chip'">
                {{ item.pending ? 'Pending' : 'Saved' }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef>User</th>
            <td mat-cell *matCellDef="let item">{{ item.scannedBy || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="time">
            <th mat-header-cell *matHeaderCellDef>Time</th>
            <td mat-cell *matCellDef="let item">
              {{ item.scannedAt ? (item.scannedAt | date:'short') : '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef>Action</th>
            <td mat-cell *matCellDef="let item">
              <button 
                *ngIf="item.pending"
                mat-icon-button 
                color="warn"
                (click)="removePending(item)"
                matTooltip="Remove from list">
                <mat-icon>delete</mat-icon>
              </button>
              <button 
                *ngIf="!item.pending && item.current_status === 'SCANNED'"
                mat-icon-button 
                color="warn"
                (click)="unscanBarcode(item)"
                [disabled]="loading"
                matTooltip="Unscan (reset to CREATED)">
                <mat-icon>undo</mat-icon>
              </button>
              <mat-icon *ngIf="!item.pending && item.current_status !== 'SCANNED'" color="primary">check_circle</mat-icon>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
              [class.pending-row]="row.pending" 
              [class.saved-row]="!row.pending"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>
